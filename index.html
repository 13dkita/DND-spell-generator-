<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <title>Kreator Kart RPG - Wersja Finalna</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@700&family=Lato:wght@400;700&display=swap');

        :root {
            /* Domyślne wartości suwaków */
            --pad-top: 40px;
            --pad-side: 35px;
            --pad-bottom: 30px;
            
            --desc-size: 10px;
            --desc-line-height: 1.25;
            --desc-spacing: 0px;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body {
            background-color: #333;
            font-family: 'Lato', sans-serif;
            display: flex;
            height: 100vh;
            overflow: hidden; 
        }

        /* --- PANEL LEWY (SIDEBAR) --- */
        .sidebar {
            width: 400px;
            background: #f8f9fa;
            padding: 15px;
            height: 100vh;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
            flex-shrink: 0;
            border-right: 5px solid #2c3e50;
            box-shadow: 5px 0 15px rgba(0,0,0,0.3);
            z-index: 20;
        }

        .sidebar > * { flex-shrink: 0; }

        /* Pasek przewijania */
        .sidebar::-webkit-scrollbar { width: 10px; }
        .sidebar::-webkit-scrollbar-track { background: #e9ecef; }
        .sidebar::-webkit-scrollbar-thumb { background: #bdc3c7; border-radius: 5px; border: 2px solid #e9ecef; }
        .sidebar::-webkit-scrollbar-thumb:hover { background: #95a5a6; }

        h2 { margin: 0; padding-bottom: 10px; border-bottom: 2px solid #ccc; font-size: 1.2rem; text-align: center; color: #2c3e50; }
        
        /* Status edycji */
        .edit-status {
            background: #34495e; color: white; padding: 10px; text-align: center; border-radius: 4px; font-weight: bold; font-size: 0.9rem;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            position: sticky; top: 0; z-index: 10;
        }

        /* Inputy */
        input[type="text"], input[type="number"], textarea, select {
            width: 100%; padding: 8px; border: 1px solid #bdc3c7; border-radius: 4px; font-size: 0.9rem; margin-bottom: 5px;
            font-family: inherit;
        }
        
        /* Grupa Checkboxów */
        .checkbox-group {
            display: flex; gap: 10px; align-items: center; background: #fff; padding: 5px; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 5px;
        }
        .checkbox-group label { margin: 0; cursor: pointer; display: flex; align-items: center; gap: 4px; font-size: 0.8rem;}

        label { display: block; font-weight: bold; font-size: 0.75rem; margin-top: 5px; margin-bottom: 2px; color: #555; }
        
        /* Sekcje rozwijane */
        details {
            background: #ffffff;
            border: 1px solid #dcdcdc;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 5px;
        }
        
        summary {
            background: #e9ecef;
            padding: 10px;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.85rem;
            color: #333;
            list-style: none;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        summary::after { content: '▼'; font-size: 0.7rem; color: #777; }
        details[open] summary::after { content: '▲'; }

        .details-content { padding: 10px; }

        /* Suwaki */
        input[type="range"] { width: 100%; cursor: pointer; margin: 5px 0 15px 0; }
        .slider-group label { display: flex; justify-content: space-between; }
        .slider-group span { font-weight: normal; color: #777; }

        /* Przyciski */
        .btn-action {
            width: 100%; padding: 10px; margin-top: 5px; cursor: pointer; font-weight: bold; border-radius: 4px; border: none; transition: 0.2s;
        }
        .btn-copy { background-color: #3498db; color: white; margin-bottom: 10px; }
        .btn-copy:hover { background-color: #2980b9; }

        .btn-json { background-color: #8e44ad; color: white; margin-bottom: 5px; }
        .btn-json:hover { background-color: #732d91; }
        
        .btn-class {
            background-color: #3498db; color: white; padding: 8px; border: none; border-radius: 4px;
            cursor: pointer; font-weight: bold; font-size: 0.8rem; transition: 0.2s;
        }
        .btn-class:hover { background-color: #2980b9; }
        .btn-class.active { background-color: #27ae60; }
        
        .btn-print { 
            background-color: #27ae60; color: white; padding: 15px; font-size: 1.1rem; 
            margin-top: auto;
            margin-bottom: 10px;
        }
        .btn-print:hover { background-color: #219150; }

        .btn-nav-page {
            background-color: #3498db; color: white; padding: 10px 20px; border: none; border-radius: 4px;
            cursor: pointer; font-weight: bold; transition: 0.2s;
        }
        .btn-nav-page:hover { background-color: #2980b9; }
        .btn-nav-page:active { background-color: #1f618d; }

        .file-upload-wrapper {
            background: #f1f1f1; padding: 8px; border: 1px dashed #999; text-align: center; border-radius: 4px; margin-bottom: 10px;
        }

        /* --- PODGLĄD (MAIN CONTENT) --- */
        .main-content {
            flex-grow: 1;
            background-color: #555;
            overflow: auto;
            padding: 40px;
            display: flex;
            justify-content: center;
        }

        /* --- STRONA A4 --- */
        .page {
            width: 210mm; height: 297mm;
            background: white; padding: 10mm;
            display: grid; grid-template-columns: repeat(3, 1fr); grid-template-rows: repeat(3, 1fr); gap: 2mm;
            box-shadow: 0 0 30px rgba(0,0,0,0.5);
            transform: scale(0.85); transform-origin: top center;
            flex-shrink: 0;
        }

        /* --- KARTA --- */
        .card {
            position: relative; width: 100%; height: 100%;
            border: 1px solid #ccc; overflow: hidden; background-color: #eee;
            cursor: pointer; transition: all 0.2s;
        }

        .card.selected-card {
            box-shadow: 0 0 0 4px #3498db; z-index: 10; border-color: #3498db;
        }

        .card-bg {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; z-index: 1;
        }

        .card-content {
            position: relative; z-index: 2; height: 100%; display: flex; flex-direction: column;
            padding-top: var(--pad-top); padding-left: var(--pad-side); padding-right: var(--pad-side); padding-bottom: var(--pad-bottom);
            transition: opacity 0.3s;
        }

        .hide-text .card-content { opacity: 0; pointer-events: none; }

        .card-title {
            font-family: 'Cinzel', serif; text-align: center; font-weight: bold; font-size: 12px; margin-bottom: 2px; text-transform: uppercase;
            text-shadow: 0 0 5px rgba(255,255,255,0.8); min-height: 15px; line-height: 1.1;
        }
        
        .card-meta {
            text-align: center; font-size: 7px; color: #444; margin-bottom: 4px; font-weight: bold; text-transform: uppercase;
            text-shadow: 0 0 3px rgba(255,255,255,0.8);
        }

        .stats-row {
            display: flex; justify-content: space-between; font-size: 10px; margin-bottom: 2px;
            border-bottom: 1px solid rgba(0,0,0,0.2); padding-bottom: 2px;
            background: rgba(255,255,255,0.3); pointer-events: none;
        }
        
        .stat-group { display: flex; flex-direction: column; max-width: 48%; }
        .stat-group.right { text-align: right; }
        .stat-label { font-size: 6px; font-weight: bold; color: #222; text-transform: uppercase; }
        .stat-val { font-weight: bold; color: #000; font-size: 9px; }

        .description {
            margin-top: 5px; 
            text-align: left; /* Zmiana: Left wygląda lepiej z pogrubionym nagłówkiem materiałów */
            white-space: pre-wrap; 
            flex-grow: 1; 
            overflow: hidden;
            font-size: var(--desc-size); 
            line-height: var(--desc-line-height); 
            letter-spacing: var(--desc-spacing);
            pointer-events: none;
        }
        
        /* Styl dla pogrubionego materiału w opisie */
        .description b {
            color: #000;
        }

        .toggle-wrapper { display: flex; align-items: center; gap: 10px; margin-top: 10px; font-size: 0.85rem; font-weight: bold; cursor: pointer; }
        .toggle-wrapper input { width: 18px; height: 18px; }

        @media print {
            .sidebar { display: none; }
            .main-content { padding: 0; background: white; display: block; overflow: visible; height: auto; }
            #pageIndicator { display: none; }
            .btn-nav-page { display: none; }
            .page { transform: none; box-shadow: none; margin: 0; width: 100%; height: 100%; }
            body { height: auto; display: block; overflow: visible; }
            .card.selected-card { box-shadow: none; border: 1px solid #ccc; }
            @page { size: A4; margin: 0; }
            * { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
        }
    </style>
</head>
<body>

    <div class="sidebar">
        <h2>Edytor Kart RPG (v3)</h2>
        
        <div class="edit-status" id="statusHeader">
            EDYTUJESZ KARTĘ #1
        </div>

        <details open>
            <summary>Presets Klas</summary>
            <div class="details-content">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 5px; margin-bottom: 10px;">
                    <button class="btn-class" onclick="selectClassPreset('artificer')">Artificer</button>
                    <button class="btn-class" onclick="selectClassPreset('bard')">Bard</button>
                    <button class="btn-class" onclick="selectClassPreset('cleric')">Cleric</button>
                    <button class="btn-class" onclick="selectClassPreset('druid')">Druid</button>
                    <button class="btn-class" onclick="selectClassPreset('paladin')">Paladin</button>
                    <button class="btn-class" onclick="selectClassPreset('ranger')">Ranger</button>
                    <button class="btn-class" onclick="selectClassPreset('sorcerer')">Sorcerer</button>
                    <button class="btn-class" onclick="selectClassPreset('warlock')">Warlock</button>
                    <button class="btn-class" onclick="selectClassPreset('wizard')">Wizard</button>
                </div>
                
                <label>Poziom zaklęcia:</label>
                <div style="display: flex; gap: 5px; margin-bottom: 10px;">
                    <div style="flex: 1;">
                        <label style="margin-top: 0; font-size: 0.7rem;">Od poziomu:</label>
                        <select id="presetLevelFrom" style="width: 100%; padding: 8px;">
                            <option value="0">Cantrip</option>
                            <option value="1">Level 1</option>
                            <option value="2">Level 2</option>
                            <option value="3">Level 3</option>
                            <option value="4">Level 4</option>
                            <option value="5">Level 5</option>
                            <option value="6">Level 6</option>
                            <option value="7">Level 7</option>
                            <option value="8">Level 8</option>
                            <option value="9">Level 9</option>
                        </select>
                    </div>
                    <div style="flex: 1;">
                        <label style="margin-top: 0; font-size: 0.7rem;">Do poziomu:</label>
                        <select id="presetLevelTo" style="width: 100%; padding: 8px;">
                            <option value="0">Cantrip</option>
                            <option value="1">Level 1</option>
                            <option value="2">Level 2</option>
                            <option value="3">Level 3</option>
                            <option value="4">Level 4</option>
                            <option value="5">Level 5</option>
                            <option value="6">Level 6</option>
                            <option value="7">Level 7</option>
                            <option value="8">Level 8</option>
                            <option value="9" selected>Level 9</option>
                        </select>
                    </div>
                </div>

                <label>Podklasa:</label>
                <select id="presetSubclass" style="width: 100%; padding: 8px; margin-bottom: 10px;">
                    <option value="">-- Wszystkie podklasy --</option>
                </select>

                <button class="btn-action btn-json" onclick="loadClassPreset()">Załaduj Zaklęcia</button>
            </div>
        </details>

        <div style="margin-top: 15px;">
            <label>Podstawowe:</label>
            <input type="text" id="inName" placeholder="Nazwa Zaklęcia" oninput="updateCurrentCard()">
            
            <div style="display:flex; gap:5px;">
                <div style="flex:1">
                    <input type="number" id="inLevel" placeholder="Level (0-9)" oninput="updateCurrentCard()">
                </div>
                <div style="flex:2">
                    <input type="text" id="inSchool" placeholder="School (e.g. Evo)" oninput="updateCurrentCard()">
                </div>
            </div>

            <div class="checkbox-group">
                <label><input type="checkbox" id="chkRitual" onchange="updateCurrentCard()"> Ritual</label>
                <label><input type="checkbox" id="chkConc" onchange="updateCurrentCard()"> Concentr.</label>
            </div>
            
            <label>Casting & Components:</label>
            <div style="display:flex; gap:5px;">
                <input type="text" id="inTime" placeholder="Casting Time" oninput="updateCurrentCard()">
                <input type="text" id="inRange" placeholder="Range" oninput="updateCurrentCard()">
            </div>
            
            <div class="checkbox-group" style="justify-content: space-around;">
                <label><input type="checkbox" id="chkV" onchange="updateCurrentCard()"> Verbal</label>
                <label><input type="checkbox" id="chkS" onchange="updateCurrentCard()"> Somatic</label>
                <label><input type="checkbox" id="chkM" onchange="updateCurrentCard()"> Material</label>
            </div>
            <textarea id="inMatDesc" rows="2" placeholder="Material Description..." oninput="updateCurrentCard()" style="font-size: 0.8em;"></textarea>

            <label>Duration & Class:</label>
            <div style="display:flex; gap:5px;">
                <input type="text" id="inDur" placeholder="Duration" oninput="updateCurrentCard()">
                <input type="text" id="inClass" placeholder="Class (e.g. Wizard)" oninput="updateCurrentCard()">
            </div>
            
            <label>Description:</label>
            <textarea id="inDesc" rows="6" placeholder="Spell description..." oninput="updateCurrentCard()"></textarea>
            
            <button class="btn-action btn-copy" onclick="copyToAll()">Kopiuj tę treść do wszystkich</button>
        </div>

        <details>
            <summary>Zarządzanie (JSON)</summary>
            <div class="details-content">
                <button class="btn-action btn-json" onclick="downloadJSON()">Pobierz JSON (Zapisz)</button>
                
                <div class="file-upload-wrapper" style="border-color: #8e44ad; background: #f4ecf7;">
                    <label style="margin-top:0;">Wczytaj plik JSON:</label>
                    <input type="file" id="jsonInput" accept=".json">
                </div>
            </div>
        </details>

        <details>
            <summary>Grafika & Rewers</summary>
            <div class="details-content">
                <div class="file-upload-wrapper">
                    <label style="margin-top:0;">1. Przód Karty:</label>
                    <input type="file" id="imgFrontInput" accept="image/*">
                </div>
                
                <div class="file-upload-wrapper" style="background: #fff3cd; border-color: #ffeeba;">
                    <label style="margin-top:0;">2. Tył Karty (Rewers):</label>
                    <input type="file" id="imgBackInput" accept="image/*">
                </div>

                <label class="toggle-wrapper">
                    <input type="checkbox" id="reverseToggle" onchange="toggleReverseMode()">
                    <span>WŁĄCZ TRYB DRUKU REWERSU</span>
                </label>
            </div>
        </details>

        <details open>
            <summary>Wygląd Globalny</summary>
            <div class="details-content">
                <div class="slider-group">
                    <label>Margines Góra: <span id="valTop">40px</span></label>
                    <input type="range" id="mTop" min="0" max="150" value="40" oninput="updateVars()">
                    
                    <label>Margines Boki: <span id="valSide">35px</span></label>
                    <input type="range" id="mSide" min="0" max="80" value="35" oninput="updateVars()">
                    
                    <label>Margines Dół: <span id="valBot">30px</span></label>
                    <input type="range" id="mBot" min="0" max="100" value="30" oninput="updateVars()">
                    
                    <hr style="margin: 10px 0; border: 0; border-top: 1px solid #eee;">
                    
                    <label>Ściśnij Linie (Interlinia):</label>
                    <input type="range" id="dLineHeight" min="0.8" max="1.6" step="0.05" value="1.25" oninput="updateVars()">
                    
                    <label>Wielkość Czcionki:</label>
                    <input type="range" id="dSize" min="6" max="14" step="0.5" value="10" oninput="updateVars()">

                    <label>Ściśnij Litery:</label>
                    <input type="range" id="dSpacing" min="-1.5" max="1" step="0.1" value="0" oninput="updateVars()">
                </div>
            </div>
        </details>

        <button class="btn-print" onclick="window.print()">DRUKUJ</button>
    </div>

    <div class="main-content">
        <div style="display: flex; flex-direction: column; align-items: center; width: 100%; gap: 15px;">
            <div id="pageIndicator" style="color: white; font-weight: bold; font-size: 1.1rem;">Strona 1 / 1</div>
            <div style="display: flex; gap: 10px;">
                <button class="btn-nav-page" onclick="prevPage()">◀ Poprzednia</button>
                <button class="btn-nav-page" onclick="addNewPage()">+ Nowa Strona</button>
                <button class="btn-nav-page" onclick="nextPage()">Następna ▶</button>
            </div>
            <div class="page" id="page"></div>
        </div>
    </div>

    <script>
        // --- DATA STRUCTURE (SEMANTIC) ---
        let currentCardIndex = 0;
        let currentPage = 0;
        const cardsPerPage = 9;
        
        // Fabryka pustego zaklęcia (Schema)
        const createEmptySpell = () => ({
            name: "",
            level: 0,
            school: "",
            meta: {
                isRitual: false,
                sourcebook: ""
            },
            casting: {
                time: "",
                range: "",
                isConcentration: false,
                duration: ""
            },
            components: {
                verbal: false,
                somatic: false,
                material: false,
                materialDescription: ""
            },
            classes: {
                main: "",
                subclasses: []
            },
            description: ""
        });

        // Inicjalizacja 9 kart
        let cardsData = Array(9).fill().map(() => createEmptySpell());
        
        let frontImageSrc = "";
        let backImageSrc = "";

        // --- FUNKCJA ŁADOWANIA PLIKU JSON ---
        function loadJSONFile(filename) {
            fetch(filename)
                .then(response => response.json())
                .then(loadedData => {
                    if (Array.isArray(loadedData)) {
                        // Resetuj dane i ustaw nową tablic na podstawie wczytanych danych
                        cardsData = Array(loadedData.length).fill().map(() => createEmptySpell());
                        
                        for (let i = 0; i < loadedData.length; i++) {
                            if (loadedData[i]) {
                                cardsData[i] = { ...createEmptySpell(), ...loadedData[i] };
                                if(loadedData[i].meta) cardsData[i].meta = { ...createEmptySpell().meta, ...loadedData[i].meta };
                                if(loadedData[i].casting) cardsData[i].casting = { ...createEmptySpell().casting, ...loadedData[i].casting };
                                if(loadedData[i].components) cardsData[i].components = { ...createEmptySpell().components, ...loadedData[i].components };
                                if(loadedData[i].classes) cardsData[i].classes = { ...createEmptySpell().classes, ...loadedData[i].classes };
                            }
                        }
                        currentPage = 0;
                        renderPage();
                        selectCard(0);
                    }
                })
                .catch(err => console.error('Nie udało się wczytać pliku:', err));
        }

        // --- KLASY PRESET ---
        let selectedClass = null;
        let allAvailableSpells = [];

        function selectClassPreset(className) {
            selectedClass = className;
            
            // Aktualizacja wybranych przycisków
            document.querySelectorAll('.btn-class').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            // Załaduj spells dla wybranej klasy
            const filename = className.toLowerCase() + '.json';
            fetch(filename)
                .then(response => response.json())
                .then(data => {
                    allAvailableSpells = data;
                    updateSubclassDropdown();
                })
                .catch(err => console.error('Nie udało się wczytać klasy:', err));
        }

        function updateSubclassDropdown() {
            const subclassSelect = document.getElementById('presetSubclass');
            const subclasses = new Set();
            
            // Zbierz wszystkie podklasy dostępne dla wybranej klasy
            allAvailableSpells.forEach(spell => {
                if (spell.classes && spell.classes.subclasses) {
                    spell.classes.subclasses.forEach(sub => {
                        if (sub !== 'ALL') {
                            subclasses.add(sub);
                        }
                    });
                }
            });
            
            // Aktualizuj dropdown
            subclassSelect.innerHTML = '<option value="">-- Wszystkie podklasy --</option>';
            subclasses.forEach(subclass => {
                const option = document.createElement('option');
                option.value = subclass;
                option.textContent = subclass;
                subclassSelect.appendChild(option);
            });
            
            // Aktualizuj level dropdowns na podstawie najwyższego poziomu dostępnego
            updateLevelDropdowns();
        }

        function updateLevelDropdowns() {
            // Znajdź minimalny i maksymalny poziom dostępny w tej klasie
            let minLevel = 9;
            let maxLevel = 0;
            allAvailableSpells.forEach(spell => {
                if (spell.level < minLevel) {
                    minLevel = spell.level;
                }
                if (spell.level > maxLevel) {
                    maxLevel = spell.level;
                }
            });
            
            const presetLevelFromSelect = document.getElementById('presetLevelFrom');
            const presetLevelToSelect = document.getElementById('presetLevelTo');
            
            // Listę wszystkich możliwych poziomów
            const levels = [
                { value: '0', label: 'Cantrip' },
                { value: '1', label: 'Level 1' },
                { value: '2', label: 'Level 2' },
                { value: '3', label: 'Level 3' },
                { value: '4', label: 'Level 4' },
                { value: '5', label: 'Level 5' },
                { value: '6', label: 'Level 6' },
                { value: '7', label: 'Level 7' },
                { value: '8', label: 'Level 8' },
                { value: '9', label: 'Level 9' }
            ];
            
            // Przebuduj dropdown "Od poziomu"
            presetLevelFromSelect.innerHTML = '';
            levels.forEach(level => {
                if (parseInt(level.value) >= minLevel && parseInt(level.value) <= maxLevel) {
                    const option = document.createElement('option');
                    option.value = level.value;
                    option.textContent = level.label;
                    if (parseInt(level.value) === minLevel) {
                        option.selected = true;
                    }
                    presetLevelFromSelect.appendChild(option);
                }
            });
            
            // Przebuduj dropdown "Do poziomu"
            presetLevelToSelect.innerHTML = '';
            levels.forEach(level => {
                if (parseInt(level.value) >= minLevel && parseInt(level.value) <= maxLevel) {
                    const option = document.createElement('option');
                    option.value = level.value;
                    option.textContent = level.label;
                    if (parseInt(level.value) === maxLevel) {
                        option.selected = true;
                    }
                    presetLevelToSelect.appendChild(option);
                }
            });
        }

        function loadClassPreset() {
            if (!selectedClass) {
                alert('Wybierz klasę!');
                return;
            }
            
            const selectedLevelFrom = parseInt(document.getElementById('presetLevelFrom').value);
            const selectedLevelTo = parseInt(document.getElementById('presetLevelTo').value);
            const selectedSubclass = document.getElementById('presetSubclass').value;
            
            // Filtruj zaklęcia
            const filteredSpells = allAvailableSpells.filter(spell => {
                // Sprawdź zakres poziomów
                if (spell.level < selectedLevelFrom || spell.level > selectedLevelTo) return false;
                
                // Sprawdź podklasę
                if (selectedSubclass) {
                    // Jeśli wybrano specyficzną podklasę
                    const hasSubclass = spell.classes && spell.classes.subclasses && 
                        (spell.classes.subclasses.includes('ALL') || spell.classes.subclasses.includes(selectedSubclass));
                    if (!hasSubclass) return false;
                }
                
                return true;
            });
            
            // Wpisz filtrowane zaklęcia do kart (z obsługą wielu stron)
            cardsData = Array(Math.max(filteredSpells.length, 9)).fill().map(() => createEmptySpell());
            
            for (let i = 0; i < filteredSpells.length; i++) {
                if (filteredSpells[i]) {
                    cardsData[i] = { ...createEmptySpell(), ...filteredSpells[i] };
                    if(filteredSpells[i].meta) cardsData[i].meta = { ...createEmptySpell().meta, ...filteredSpells[i].meta };
                    if(filteredSpells[i].casting) cardsData[i].casting = { ...createEmptySpell().casting, ...filteredSpells[i].casting };
                    if(filteredSpells[i].components) cardsData[i].components = { ...createEmptySpell().components, ...filteredSpells[i].components };
                    if(filteredSpells[i].classes) cardsData[i].classes = { ...createEmptySpell().classes, ...filteredSpells[i].classes };
                }
            }
            
            currentPage = 0;
            renderPage();
            selectCard(0);
            updatePageInfo();
            
            alert(`Załadowano ${filteredSpells.length} zaklęć!`);
        }

        // --- INICJALIZACJA UI ---
        const page = document.getElementById('page');
        const cardTemplate = `
            <div class="card-bg-wrapper"><img src="" class="card-bg"></div>
            <div class="card-content">
                <div class="card-title">NAZWA</div>
                <div class="card-meta">LEVEL 1 SCHOOL</div>
                <div class="stats-row">
                    <div class="stat-group"><span class="stat-label">Time</span><span class="stat-val v-time">-</span></div>
                    <div class="stat-group right"><span class="stat-label">Range</span><span class="stat-val v-range">-</span></div>
                </div>
                <div class="stats-row">
                    <div class="stat-group"><span class="stat-label">Components</span><span class="stat-val v-comp">-</span></div>
                    <div class="stat-group right"><span class="stat-label">Duration</span><span class="stat-val v-dur">-</span></div>
                </div>
                <div class="description">Opis...</div>
            </div>
        `;

        // Funkcja renderująca stronę
        function renderPage() {
            page.innerHTML = '';
            const startIndex = currentPage * cardsPerPage;
            const endIndex = Math.min(startIndex + cardsPerPage, cardsData.length);
            
            for (let i = startIndex; i < endIndex; i++) {
                let div = document.createElement('div');
                div.className = 'card';
                div.dataset.index = i;
                div.onclick = function() { selectCard(i); };
                div.innerHTML = cardTemplate;
                page.appendChild(div);
                renderCard(i);
            }
        }

        renderPage();
        selectCard(0);
        updatePageInfo();
        
        // Automatyczne wczytanie example.json przy otwarciu strony
        loadJSONFile('example.json');

        // --- LOGIKA UI ---
        function selectCard(index) {
            currentCardIndex = index;
            
            // Zmień stronę jeśli potrzeba
            const pageNeeded = Math.floor(index / cardsPerPage);
            if (pageNeeded !== currentPage) {
                currentPage = pageNeeded;
                renderPage();
            }
            
            document.querySelectorAll('.card').forEach(c => c.classList.remove('selected-card'));
            document.querySelector(`.card[data-index="${index}"]`).classList.add('selected-card');
            
            document.getElementById('statusHeader').innerHTML = `EDYTUJESZ KARTĘ #${index + 1}<div style="font-weight: normal; font-size: 0.7em; margin-top:3px;">(Kliknij inną kartę na podglądzie, aby zmienić)</div>`;

            const data = cardsData[index];
            
            // Mapowanie JSON -> Pola Input
            document.getElementById('inName').value = data.name || "";
            document.getElementById('inLevel').value = data.level;
            document.getElementById('inSchool').value = data.school || "";
            
            document.getElementById('chkRitual').checked = data.meta.isRitual;
            document.getElementById('chkConc').checked = data.casting.isConcentration;

            document.getElementById('inTime').value = data.casting.time || "";
            document.getElementById('inRange').value = data.casting.range || "";
            document.getElementById('inDur').value = data.casting.duration || "";
            
            document.getElementById('chkV').checked = data.components.verbal;
            document.getElementById('chkS').checked = data.components.somatic;
            document.getElementById('chkM').checked = data.components.material;
            document.getElementById('inMatDesc').value = data.components.materialDescription || "";

            document.getElementById('inClass').value = data.classes.main || "";
            document.getElementById('inDesc').value = data.description || "";
        }

        // --- FUNKCJE PAGINACJI ---
        function updatePageInfo() {
            const totalPages = Math.ceil(cardsData.length / cardsPerPage);
            const pageIndicator = document.getElementById('pageIndicator');
            if (pageIndicator) {
                pageIndicator.innerHTML = `Strona ${currentPage + 1} / ${totalPages}`;
            }
        }

        function nextPage() {
            const totalPages = Math.ceil(cardsData.length / cardsPerPage);
            if (currentPage < totalPages - 1) {
                currentPage++;
                renderPage();
                updatePageInfo();
                selectCard(currentPage * cardsPerPage);
            }
        }

        function prevPage() {
            if (currentPage > 0) {
                currentPage--;
                renderPage();
                updatePageInfo();
                selectCard(currentPage * cardsPerPage);
            }
        }

        function addNewPage() {
            // Dodaj 9 nowych pustych kart
            const newCards = Array(cardsPerPage).fill().map(() => createEmptySpell());
            cardsData = cardsData.concat(newCards);
            currentPage = cardsData.length - cardsPerPage;
            renderPage();
            updatePageInfo();
            selectCard(currentPage * cardsPerPage);
            alert('Dodano nową stronę!');
        }

        function updateCurrentCard() {
            // Mapowanie Pola Input -> JSON
            const data = cardsData[currentCardIndex];
            
            data.name = document.getElementById('inName').value;
            data.level = parseInt(document.getElementById('inLevel').value) || 0;
            data.school = document.getElementById('inSchool').value;
            
            data.meta.isRitual = document.getElementById('chkRitual').checked;
            data.casting.isConcentration = document.getElementById('chkConc').checked;
            
            data.casting.time = document.getElementById('inTime').value;
            data.casting.range = document.getElementById('inRange').value;
            data.casting.duration = document.getElementById('inDur').value;
            
            data.components.verbal = document.getElementById('chkV').checked;
            data.components.somatic = document.getElementById('chkS').checked;
            data.components.material = document.getElementById('chkM').checked;
            data.components.materialDescription = document.getElementById('inMatDesc').value;
            
            data.classes.main = document.getElementById('inClass').value;
            data.description = document.getElementById('inDesc').value;

            renderCard(currentCardIndex);
        }

        function renderCard(index) {
            const cardEl = document.querySelector(`.card[data-index="${index}"]`);
            const data = cardsData[index];
            
            // Podstawowe dane
            cardEl.querySelector('.card-title').innerText = data.name || "";
            
            // Budowanie linii Meta (Level, Szkoła, Rytuał, Klasy)
            let metaString = "";
            if(data.level == 0) metaString += "Cantrip";
            else metaString += `Level ${data.level}`;
            
            if(data.school) metaString += ` ${data.school}`;
            if(data.meta.isRitual) metaString += " (R)";
            if(data.classes.main) metaString += ` - ${data.classes.main}`;
            
            cardEl.querySelector('.card-meta').innerText = metaString;

            // Statystyki
            cardEl.querySelector('.v-time').innerText = data.casting.time || "-";
            cardEl.querySelector('.v-range').innerText = data.casting.range || "-";
            
            // Duration + Koncentracja
            let durString = data.casting.duration || "-";
            if(data.casting.isConcentration) durString += " (C)";
            cardEl.querySelector('.v-dur').innerText = durString;

            // Komponenty (Tylko litery V, S, M)
            let comps = [];
            if(data.components.verbal) comps.push("V");
            if(data.components.somatic) comps.push("S");
            if(data.components.material) comps.push("M");
            
            cardEl.querySelector('.v-comp').innerText = comps.join(", ") || "-";

            // Opis + Materiał Pogrubiony
            let descHtml = "";
            
            // Warunek: M musi być zaznaczone i musi być opis materiału
            if(data.components.material && data.components.materialDescription) {
                descHtml += `<b>Material:</b> ${data.components.materialDescription}\n\n`;
            }
            
            descHtml += data.description || "";
            
            // Użycie innerHTML dla obsługi <b>
            cardEl.querySelector('.description').innerHTML = descHtml;
        }

        function copyToAll() {
            // Klonowanie głębokie (deep copy) przez JSON
            const currentData = JSON.stringify(cardsData[currentCardIndex]);
            for(let i=0; i<9; i++) {
                cardsData[i] = JSON.parse(currentData);
                renderCard(i);
            }
            alert("Treść skopiowana do wszystkich kart!");
        }

        // --- JSON IMPORT/EXPORT ---
        function downloadJSON() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(cardsData, null, 2));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", "rpg_karty_v3.json");
            document.body.appendChild(downloadAnchorNode); 
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        }

        document.getElementById('jsonInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(evt) {
                try {
                    const loadedData = JSON.parse(evt.target.result);
                    if (Array.isArray(loadedData)) {
                        for (let i = 0; i < 9; i++) {
                            if (loadedData[i]) {
                                // Scalanie danych z domyślnym obiektem (aby nie zgubić kluczy)
                                cardsData[i] = { ...createEmptySpell(), ...loadedData[i] };
                                
                                // Scalanie zagnieżdżonych obiektów
                                if(loadedData[i].meta) cardsData[i].meta = { ...createEmptySpell().meta, ...loadedData[i].meta };
                                if(loadedData[i].casting) cardsData[i].casting = { ...createEmptySpell().casting, ...loadedData[i].casting };
                                if(loadedData[i].components) cardsData[i].components = { ...createEmptySpell().components, ...loadedData[i].components };
                                if(loadedData[i].classes) cardsData[i].classes = { ...createEmptySpell().classes, ...loadedData[i].classes };
                            }
                        }
                        cardsData.forEach((_, index) => renderCard(index));
                        selectCard(currentCardIndex);
                        alert("Pomyślnie wczytano dane!");
                    } else {
                        alert("Błąd: Plik JSON ma niepoprawny format.");
                    }
                } catch (err) {
                    console.error(err);
                    alert("Błąd parsowania: " + err.message);
                }
                e.target.value = '';
            };
            reader.readAsText(file);
        });

        // --- OBRAZKI I REWERS ---
        document.getElementById('imgFrontInput').addEventListener('change', function(e) { loadFile(e.target.files[0], true); });
        document.getElementById('imgBackInput').addEventListener('change', function(e) { loadFile(e.target.files[0], false); });

        function loadFile(file, isFront) {
            if(!file) return;
            const reader = new FileReader();
            reader.onload = function(evt) {
                if(isFront) frontImageSrc = evt.target.result;
                else backImageSrc = evt.target.result;
                refreshImages();
            };
            reader.readAsDataURL(file);
        }

        function toggleReverseMode() {
            const isReverse = document.getElementById('reverseToggle').checked;
            const pageContainer = document.getElementById('page');
            const statusHeader = document.getElementById('statusHeader');
            
            if (isReverse) {
                pageContainer.classList.add('hide-text');
                statusHeader.innerText = "TRYB DRUKU REWERSU (TYŁU)";
                statusHeader.style.background = "#e67e22";
            } else {
                pageContainer.classList.remove('hide-text');
                selectCard(currentCardIndex); 
                statusHeader.style.background = "#34495e";
            }
            refreshImages();
        }

        function refreshImages() {
            const isReverse = document.getElementById('reverseToggle').checked;
            const targetSrc = isReverse ? backImageSrc : frontImageSrc;
            document.querySelectorAll('.card-bg').forEach(img => {
                if (isReverse && !backImageSrc) img.src = "";
                else if (!isReverse && !frontImageSrc) img.src = "";
                else img.src = targetSrc;
            });
        }

        // --- STYLE SUWAKÓW ---
        function updateVars() {
            const root = document.documentElement.style;
            const top = document.getElementById('mTop').value;
            const side = document.getElementById('mSide').value;
            const bot = document.getElementById('mBot').value;

            root.setProperty('--pad-top', top + 'px');
            root.setProperty('--pad-side', side + 'px');
            root.setProperty('--pad-bottom', bot + 'px');
            
            document.getElementById('valTop').innerText = top + 'px';
            document.getElementById('valSide').innerText = side + 'px';
            document.getElementById('valBot').innerText = bot + 'px';

            root.setProperty('--desc-line-height', document.getElementById('dLineHeight').value);
            root.setProperty('--desc-size', document.getElementById('dSize').value + 'px');
            root.setProperty('--desc-spacing', document.getElementById('dSpacing').value + 'px');
        }
    </script>
</body>
</html>